{% load static %}
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>mainpage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/app2.css' %}">
    <script src="https://kit.fontawesome.com/7e0916f0c5.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <header id="header" class="col">
          <img id="logo" src="{% static 'img/logo.png' %}" alt="app logo">
          <h1>Dublin Bus</h1>
        </header>
      </div>
      <div id="main_section" class="row">
        <div id="map" class="col-md-9 "></div>
        <div id="form" class="col-md-3 d-none d-md-block">
          <div class="row form_header">
            <h4>Travel Time Predictor</h4>
          </div>
          <div class="row input">
            <input id="originInput" class="form-control" type="text" placeholder="Enter Origin" autocomplete="on" runat="server" onclick="setOrigin()"/>
          </div>
          <div class="row input">
            <input id="destinationInput" class="form-control" type="text" placeholder="Enter Destination" autocomplete="on" runat="server" onclick="setDestination()"/>
          </div>
          <div class="row input">
            <select id="date">
              <option value="Null" selected>Enter Date</option>
            </select>
          </div>
          <div class="row input">
            <select id="time">
              <option value="Null" selected>Enter time</option>
            </select>
          </div>
          <div class="row input">
            <input id="submit" type="submit" class="form-control font-weight-bold align-middle" value="Go!" onclick="searchRoute()">
          </div>
          <div class="row form_header">
            <h4>Search Bus Routes</h4>
          </div>
          <div class="row input">
            <select id="bus_line">
              <option value="Null" selected>Enter Bus Line</option>
            </select>
          </div>
          <div class="row input">
            <input id="submit2" type="submit" class="form-control font-weight-bold align-middle" value="Search" onclick="showRoute()">
          </div>
        </div>
      </div>
      <div class="row bottom_drop">
        <div class="col-4 d-sm-none">
          <div id="bottom_button">
            <p id="bottom_title">Events</p>
          </div>
        </div>
      </div>
      <div id="events" class="row">
        <div id="event1" class="col-md d-none d-md-block">
          <div class="event">
            <div class="event_date">
              <span class="grey_text">JUN</span>
              <span>12</span>
            </div>
            <div class="event_info">
              <span class="grey_text">Thu - 18:00</span>
              <span>Fleetwood Mac</span>
              <span class="grey_text">RDS Arena - Dublin</span>
            </div>
          </div>
        </div>
        <div id="event2" class="col-md d-none d-md-block">
          <div class="event">
            <div class="event_date">
              <span class="grey_text">JUN</span>
              <span>14</span>
            </div>
            <div class="event_info">
              <span class="grey_text">Fri - 17:00</span>
              <span>Mumford & Sons</span>
              <span class="grey_text">Malahide Castle - Co. Dublin</span>
            </div>
          </div>
        </div>
        <div id="event3" class="col-md d-none d-md-block">
          <div class="event">
            <div class="event_date">
              <span class="grey_text">JUN</span>
              <span>15</span>
            </div>
            <div class="event_info">
              <span class="grey_text">Sat - 18:00</span>
              <span>Bon Jovi: This House Is Not for Sale</span>
              <span class="grey_text">RDS Arena - Dublin</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      var bus_lines = JSON.parse("{{ bus_lines }}".replace(/&quot;/g,"\""));
      // console.log(bus_lines);

      for (var i=0; i<bus_lines.length; i++) {
        document.getElementById('bus_line').innerHTML += '<option>' + bus_lines[i][0] + ' (' + bus_lines[i][1] + ')</option>';
      }

      // Create new date object after custom number of days have passed
      Date.prototype.addDays = function(days) {
        var date = new Date(this.valueOf());
        date.setDate(date.getDate() + days);
        return date;
      }

      // Create options for five days  (up to weather forecast possibilities)
      var dateNew = new Date();
      var dateNew1 = dateNew.addDays(1);
      var dateNew2 = dateNew.addDays(2);
      var dateNew3 = dateNew.addDays(3);
      var dateNew4 = dateNew.addDays(4);

      var ourdate = dateNew.getFullYear() + "-" + ("0"+(dateNew.getMonth()+1)).slice(-2) + "-" + ("0"+dateNew.getDate()).slice(-2);
      var ourDate1 = dateNew1.getFullYear() + "-" + ("0"+(dateNew1.getMonth()+1)).slice(-2) + "-" + ("0"+dateNew1.getDate()).slice(-2);
      var ourDate2 = dateNew2.getFullYear() + "-" + ("0"+(dateNew2.getMonth()+1)).slice(-2) + "-" + ("0"+dateNew2.getDate()).slice(-2);
      var ourDate3 = dateNew3.getFullYear() + "-" + ("0"+(dateNew3.getMonth()+1)).slice(-2) + "-" + ("0"+dateNew3.getDate()).slice(-2);
      var ourDate4 = dateNew4.getFullYear() + "-" + ("0"+(dateNew4.getMonth()+1)).slice(-2) + "-" + ("0"+dateNew4.getDate()).slice(-2);

      document.getElementById('date').innerHTML += "<option value='"+ourdate+"'>"+ourdate.slice(-2) + '/' + ourdate.slice(5,7)+"</option><option value='"+ourDate1+"'>"+ourDate1.slice(-2) + '/' + ourDate1.slice(5,7)+"</option><option value='"+ourDate2+"'>"+ourDate2.slice(-2) + '/' + ourDate2.slice(5,7)+"</option><option value='"+ourDate3+"'>"+ourDate3.slice(-2) + '/' + ourDate3.slice(5,7)+"</option><option value='"+ourDate4+"'>"+ourDate4.slice(-2) + '/' + ourDate4.slice(5,7)+"</option>"

      var value;
      for (var j = 0; j < 24; j++) {
        for (var k = 0; k < 60; k+=10) {
          if (k == 0) {
            value = ('0' + j + ':0' + k + ':00').slice(-8);
          } else {
            value = ('0' + j + ':' + k + ':00').slice(-8);
          }
          document.getElementById('time').innerHTML += "<option value='" + value + "'>" + value.slice(0,5) +"</option>";
        }
      }

      function myFunction(media_query) {
        if (media_query.matches) {
          document.getElementById('header').innerHTML = '<img id="logo" src="{% static 'img/logo.png' %}" alt="app logo"><h1>Dublin Bus</h1><button id="burger_button" type="menu" name="button" onclick="toggle_menu()"><div class="burger"></div><div class="burger"></div><div class="burger"></div></button>';
          document.getElementById('submit').addEventListener("click", function() {
            $("#form").addClass("d-none");
            $("#form").addClass("d-md-block");
            $("#form").addClass("col-md-3");
            toggle_count = 0;
          });
        } else {
          document.getElementById('header').innerHTML = '<img id="logo" src="{% static 'img/logo.png' %}" alt="app logo"><h1>Dublin Bus</h1>';
        }
      }

      var media_query = window.matchMedia('(max-width: 767px)');
      myFunction(media_query);
      media_query.addListener(myFunction);

      var toggle_count = 0;
      function toggle_menu() {
        if (toggle_count == 0) {
          $("#form").removeClass("d-none");
          $("#form").removeClass("d-md-block");
          $("#form").removeClass("col-md-3");
          // $("#form").css({"border-left":"1px solid black"});
          // $("#form").css({"border-bottom":"1px solid black"});
          toggle_count = 1;
          if (toggle_count2 == 1) {
            document.getElementById('bottom_title').click();
          }
        } else {
          $("#form").addClass("d-none");
          $("#form").addClass("d-md-block");
          $("#form").addClass("col-md-3");
          // $("#form").css({"border":"0px"});
          toggle_count = 0;
        }
      }

      var toggle_count2 = 0;
      document.getElementById('bottom_button').addEventListener("click", function() {
        if (toggle_count2 == 0) {
          $("#event1").removeClass("d-none");
          $("#event1").removeClass("d-md-block");
          $("#event2").removeClass("d-none");
          $("#event2").removeClass("d-md-block");
          $("#event3").removeClass("d-none");
          $("#event3").removeClass("d-md-block");
          toggle_count2 = 1;
          $(".bottom_drop").css({"top":"50vh"});
        } else {
          $("#event1").addClass("d-none");
          $("#event1").addClass("d-md-block");
          $("#event2").addClass("d-none");
          $("#event2").addClass("d-md-block");
          $("#event3").addClass("d-none");
          $("#event3").addClass("d-md-block");
          toggle_count2 = 0;
          $(".bottom_drop").css({"top":"95vh"});
        }
      })

      var events_content = document.getElementById('events').innerHTML;

      function showRoute() {
        var bus_line = document.getElementById('bus_line').value;
        $.ajax({
          type: "POST",
          url: "{{ 'show_route/' }}",
          data: { csrfmiddlewaretoken: '{{ csrf_token }}', bus_line: bus_line },
          success: function(response) {
            var myData = JSON.parse(response);
            console.log(myData);

            var myCenter = {lat: 53.349605, lng:-6.264175 };
            var mapCanvas = document.getElementById("map");
            var mapOptions = {center: myCenter, zoom: 11};
            var map = new google.maps.Map(mapCanvas, mapOptions);
            infowindow = new google.maps.InfoWindow({
              maxWidth: 355
            });

            for(var j=0; j<myData.route_stops.length; j++) {
              var marker=new google.maps.Marker({
              position:new google.maps.LatLng(myData.route_stops[j][7],myData.route_stops[j][9]),
              map:map,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 2.5,
                fillColor: 'white',
                fillOpacity: 1.0,
                strokeWeight: 2
              },
              stop_id: myData.route_stops[j][1],
              stop_name: myData.route_stops[j][11]
              });

              popupDirections(marker);
            }

            function popupDirections(marker) {
              google.maps.event.addListener(marker, 'click', function() {
                for (var i=0; i<myData.route_stops.length; i++) {
                  infowindow.setContent('Stop Number: ' + marker.stop_id.slice(-4) + '<br> Stop Name: ' + marker.stop_name);
                }
                infowindow.open(map, marker);
              });
            }
          }
        })
        document.getElementById('events').innerHTML = events_content;
        document.getElementById('bottom_title').innerHTML = 'Events';
        if (media_query.matches) {
          document.getElementById('burger_button').click();
        }
      }

      // Google Maps -------------------
      function myMap() {
        var myCenter = {lat: 53.349605, lng:-6.264175 };
        var mapCanvas = document.getElementById("map");
        var mapOptions = {center: myCenter, zoom: 11};
        var map = new google.maps.Map(mapCanvas, mapOptions);
        infowindow = new google.maps.InfoWindow({
          maxWidth: 355
        });
      }

      function setOrigin() {
        var origin = document.getElementById("originInput");
        var autocomplete = new google.maps.places.Autocomplete(origin);
        autocomplete.setComponentRestrictions({'country': ['ie']});
        google.maps.event.addListener(autocomplete, "place_changed", function() {
          var place = autocomplete.getPlace();
          var latOrigin = place.geometry.location.lat();
          var lngOrigin = place.geometry.location.lng();
        })
      }

      function setDestination() {
        var destination = document.getElementById("destinationInput");
        var autocomplete = new google.maps.places.Autocomplete(destination);
        autocomplete.setComponentRestrictions({'country': ['ie']});
        google.maps.event.addListener(autocomplete, "place_changed", function() {
          var place = autocomplete.getPlace();
          var latDestination = place.geometry.location.lat();
          var lngdestination = place.geometry.location.lng();
        })
      }

      function searchRoute() {
        var origin = document.getElementById("originInput").value;
        var destination = document.getElementById("destinationInput").value;

        $.ajax({
          type: "POST",
          url: "{{ 'search_route/' }}",
          data: { csrfmiddlewaretoken: '{{ csrf_token }}', origin: origin, destination: destination },
          success: function(response) {
            var myData = JSON.parse(response);
            console.log(myData);
            if (myData.googleRequest.length < 1) {
              window.alert('Error: No results found');
            } else {
              var secondArray = new Array(4);
              secondArray[0] = myData.googleRequest.routes[0].legs[0].start_location.lat;
              secondArray[1] = myData.googleRequest.routes[0].legs[0].start_location.lng;
              secondArray[2] = myData.googleRequest.routes[0].legs[0].end_location.lat;
              secondArray[3] = myData.googleRequest.routes[0].legs[0].end_location.lng;
              displayRoute(secondArray, myData.middle_stops);

              var journey_summary = '<p>';
              var steps = myData.googleRequest.routes[0].legs[0].steps;
              for (var i = 0; i < steps.length; i++) {
                if (steps[i].travel_mode == 'WALKING') {
                  journey_summary += '<i class="fas fa-walking"></i> ' + steps[i].duration.text.slice(0,-5);
                } else if (steps[i].travel_mode == 'TRANSIT') {
                  journey_summary += '<i class="fas fa-bus"></i> ' + steps[i].transit_details.line.short_name;
                }
                if (i < steps.length -1) {
                  journey_summary += '<i class="fas fa-angle-right step_arrow"></i>'
                }
              }
              journey_summary += '</p>';
              var journey_steps = '';
              for (var i = 0; i < steps.length; i++) {
                journey_steps += '<p class="journey_step"><span>' + (i+1) + '. </span>'+ steps[i].html_instructions + '</p>';
              }

              document.getElementById('bottom_title').innerHTML = 'Journey';
              document.getElementById('events').innerHTML = '<div id="event1" class="col-md-4 d-none d-md-block"><div class="event"><div class="event_date"><span class="grey_text">INFO</span><span class="grey_text"style="font-size: 2em;"><i class="fas fa-info-circle"></i></span></div><div class="event_info">'+journey_summary+'<span><i class="fas fa-flag-checkered distance_time"></i> '+myData.googleRequest.routes[0].legs[0].distance.text+'</span><span><i class="fas fa-stopwatch distance_time"></i> '+myData.googleRequest.routes[0].legs[0].duration.text+'</span></div></div></div><div id="event2" class="col-md-4 d-none d-md-block"><div class="event"><div class="event_date"><span class="grey_text">STEPS</span><span class="grey_text" style="font-size: 2em;"><i class="fas fa-directions"></i></span></div><div class="event_info journey_steps">'+journey_steps+'</div></div></div><div id="event3" class="col-md-4 d-none d-md-block"><div class="event"><div class="event_date"><span class="grey_text">ECO</span><span class="grey_text" style="font-size: 2em;"><i class="fas fa-globe-americas"></i></span></div><div class="event_info"><span></span><span>Weather Forecast - Rain</span><span>CO2 Emission - 0.0 tonnes</span></div></div></div>';
              if (media_query.matches) {
                document.getElementById('bottom_title').click();
              }
            }
          }
        })
      }

      function displayRoute(addresses, middle_stops) {
        var directionsDisplay = new google.maps.DirectionsRenderer;
        var directionsService = new google.maps.DirectionsService;

        var myCenter = {lat: 53.349605, lng:-6.264175 };
        var mapCanvas = document.getElementById("map");
        var mapOptions = {center: myCenter, zoom: 11};
        var map = new google.maps.Map(mapCanvas, mapOptions);
        infowindow = new google.maps.InfoWindow({
          maxWidth: 355
        });

        directionsDisplay.setMap(map);


        directionsService.route({
          origin: {lat: addresses[0], lng: addresses[1]},
          destination: {lat: addresses[2], lng: addresses[3]},
          travelMode: google.maps.TravelMode['TRANSIT'],
          transitOptions: {modes: ['BUS']}
          // ,provideRouteAlternatives: true
        }, function(response, status) {
          if (status == 'OK') {
            directionsDisplay.setDirections(response);
          } else {
            window.alert('Error:' + status);
          }
        });

        for (var i = 0; i < middle_stops.length; i++) {
          if (typeof middle_stops[i] != 'string') {
            for(var j=0; j<middle_stops[i].length; j++) {
              var marker=new google.maps.Marker({
              position:new google.maps.LatLng(middle_stops[i][j][4],middle_stops[i][j][5]),
              map:map,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 2.5,
                fillColor: 'white',
                fillOpacity: 1.0,
                strokeWeight: 1
              },
              stop_id: middle_stops[i][j][0],
              stop_name: middle_stops[i][j][6]
              });

              popupDirections(marker);
            }
          }
        }

        function popupDirections(marker) {
          google.maps.event.addListener(marker, 'click', function() {
            for (var i=0; i<middle_stops.length; i++) {
              infowindow.setContent('Stop Number: ' + marker.stop_id.slice(-4) + '<br> Stop Name: ' + marker.stop_name);
            }
            infowindow.open(map, marker);
          });
        }
      }

    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key={{ apikey }}&callback=myMap&libraries=places"></script>

  </body>
</html>
