<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>mainpage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <header class="col">
          <h1>Dublin Bus Predictor</h1>
        </header>
      </div>
      <div class="row">
        <div id="map" class="col-lg-8" style="height: 70vh"></div>
        <div id="form" class="col-lg-4">
          <div id="form_header" class="row">
            <h4>Journey Travel Time</h4>
          </div>
          <div id="from" class="row">
            <input id="originInput" type="text" size="40" placeholder="Enter Origin" autocomplete="on" runat="server" onclick="setOrigin()"/>
          </div>
          <div id="to" class="row">
            <input id="destinationInput" type="text" size="40" placeholder="Enter Destination" autocomplete="on" runat="server" onclick="setDestination()"/>
          </div>
          <div id="bus_line" class="row">
            <input id="destinationInput" type="text" size="40" placeholder="Enter Bus Line"/>
          </div>
          <div id="date" class="row">
            <input id="destinationInput" type="text" size="40" placeholder="Enter Date"/>
          </div>
          <div id="time" class="row">
            <input id="destinationInput" type="text" size="40" placeholder="Enter Time"/>
          </div>
          <div class="row">
            <input type="submit" value="Go!" onclick="searchRoute()">
          </div>
        </div>

      </div>
      <div id="events" class="row">
        <span class="col">event</span>
        <span class="col">event</span>
        <span class="col">event</span>
        <span class="col">event</span>
      </div>
    </div>

    <script type="text/javascript">
      // var data = JSON.parse("{{ apikey }}".replace(/&quot;/g,"\""));
      // console.log(data);

      // Google Maps -------------------
      // var lats = new Array(data.length);
      // var lons = new Array(data.length);
      // var latlons = new Array(data.length);
      // var addresses = new Array(data.length);
      // var stopnumbers = new Array(data.length);
      //
      // for (var i=0; i<data.length; i++) {
      //   lats[i] = data[i][0];
      //   lons[i] = data[i][1];
      //   latlons[i] = [data[i][0], data[i][1]];
      //   addresses[i] = data[i][3];
      //   stopnumbers[i] = data[i][2];
      // }

      function myMap() {
        var myCenter = {lat: 53.349605, lng:-6.264175 };
        var mapCanvas = document.getElementById("map");
        var mapOptions = {center: myCenter, zoom: 11};
        var map = new google.maps.Map(mapCanvas, mapOptions);
        infowindow = new google.maps.InfoWindow({
          maxWidth: 355
        });

        // for(var j=0; j<latlons.length; j++) {
        //   var marker=new google.maps.Marker({
        //   position:new google.maps.LatLng(latlons[j][0],latlons[j][1]),
        //   map:map,
        //   address: addresses[j],
        //   stopnumber: stopnumbers[j]
        //   });
        //
        //   popupDirections(marker);
        // }
      }

      // function popupDirections(marker) {
      //   google.maps.event.addListener(marker, 'click', function() {
      //     for (var i=0; i<data.length; i++) {
      //       infowindow.setContent('Address: ' + marker.address + '<br> Stop Number: ' + marker.stopnumber);
      //     }
      //     infowindow.open(map, marker);
      //   });
      // }

      function setOrigin() {
        var origin = document.getElementById("originInput");
        var autocomplete = new google.maps.places.Autocomplete(origin);
        google.maps.event.addListener(autocomplete, "place_changed", function() {
          var place = autocomplete.getPlace();
          var latOrigin = place.geometry.location.lat();
          var lngOrigin = place.geometry.location.lng();
        })
      }

      function setDestination() {
        var destination = document.getElementById("destinationInput");
        var autocomplete = new google.maps.places.Autocomplete(destination);
        google.maps.event.addListener(autocomplete, "place_changed", function() {
          var place = autocomplete.getPlace();
          var latDestination = place.geometry.location.lat();
          var lngdestination = place.geometry.location.lng();
        })
      }

      function searchRoute() {
        var origin = document.getElementById("originInput").value;
        var destination = document.getElementById("destinationInput").value;

        $.ajax({
          type: "POST",
          url: "{{ 'search_route/' }}",
          data: { csrfmiddlewaretoken: '{{ csrf_token }}', origin: origin, destination: destination },
          success: function(response) {
            var myData = JSON.parse(response);
            console.log(myData);
            if (myData.length < 1) {
              window.alert('Error: No results found');
            } else {
              var secondArray = new Array(4);
              secondArray[0] = myData.routes[0].legs[0].start_location.lat;
              secondArray[1] = myData.routes[0].legs[0].start_location.lng;
              secondArray[2] = myData.routes[0].legs[0].end_location.lat;
              secondArray[3] = myData.routes[0].legs[0].end_location.lng;
              displayRoute(secondArray);
            }
          }
        })
      }

      function displayRoute(addresses) {
        var directionsDisplay = new google.maps.DirectionsRenderer;
        var directionsService = new google.maps.DirectionsService;

        var myCenter = {lat: 53.349605, lng:-6.264175 };
        var mapCanvas = document.getElementById("map");
        var mapOptions = {center: myCenter, zoom: 11};
        var map = new google.maps.Map(mapCanvas, mapOptions);
        infowindow = new google.maps.InfoWindow({
          maxWidth: 355
        });

        directionsDisplay.setMap(map);


        directionsService.route({
          origin: {lat: addresses[0], lng: addresses[1]},
          destination: {lat: addresses[2], lng: addresses[3]},
          travelMode: google.maps.TravelMode['TRANSIT']
        }, function(response, status) {
          if (status == 'OK') {
            directionsDisplay.setDirections(response);
          } else {
            window.alert('Error:' + status);
          }
        });
      }

    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key={{ apikey }}&callback=myMap&libraries=places"></script>

  </body>
</html>
